![CmuLogo](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfDdcG1ckfBCfU5NV48spgVNHR-9M9Dy5KO2H0jRPND1uUSF8CvRGEVVYLttDn5mq_kzaFHHLUwpbendqOMW2Ley7CeO7VIf15C55EtUN6hXazL0LrfMER_xvDVWOZVnWMFJYguz3iZBmRDkvejIT1VeTCtxrJhp=s800)

CHIANG MAI UNIVERSITY

Bachelor of Science (Software Engineering)

College of Arts, Media and Technology

1st Semester / Academic Year 2025

SE 331 Component Based Software Development

![](https://web.archive.org/web/20250925082143im_/https://docs.google.com/drawings/d/1ERlD3cA5oDcfMmw8Xg-3RniJziwBKPdzF2H3wLUofioxQG6jyWsAypUoVPGUwA9AFuArWJimQusF3p__KyUP3PDPMBUH/image?parent=1eOcay91mdeVi2zlLwmB1wKrrIdE00kuB&amp;rev=1&amp;drawingRevisionAccessToken=K7hzzTipaNNrAw&amp;h=11&amp;w=11&amp;ac=1)

Using Cloud services

Name …………………..……………. ID ……………………

_Objective_ In this session, you may try to  upload the file to Firebase

_Suggestion _you should read the instructions step by step. Please try to answer question by question without skipping some questions which you think it is extremely difficult.

_Hint _ The symbol + and – in front of the source code is to show that you have to remove the source code and add the source code only. There are not the part of the source code

1. Using Firebase Storage, open the https://console.firebase.google.com/ to open the firebase console using your google account

1.1. Create a new firebase project (or you can use old project if you want)

![](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfB4vtwHxdXkfwEuw2DvCNp3mPORVjhndD3sGODnnfSElQQMGCcOmnIxp3JDN2u4Q9MGgw_p-cdaBFcqxuDJ4QCLmT_KnidxdhdRCYRbNxyUFEpB18eUOgP5OrELpaH86irK9QjYkAmbsj0zwcDIoHwDw0qu58ya=s800)

1.2. you may be asked for the google analytic, use the default value, and select the suggest analytics.
1.3. After firebase has created your project, Select Build, Storage then click get Start on the storage page

![A screenshot of a blue screen

Description automatically generated](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfBG1J-nMpytsFY3O29K4T_5H-JiKd8HMC2p9pHVXny-j4A301npD7YlMhbD3A4RMFVBgZo_XDwNgSuw40QrYIESJYpidiio7EGZYxcqg9wO74aIYbFIR_6a1HF1t12ovNL0GOT3StXysOj63nDWDBgll7mjhJZ2=s800)

You will be routed to Setup page.

![](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfBuDWKGn_ycIFohyQ7mq2KN-gc_N_KHEFB6BOFUzQ8h3PEPc8W2oi-u3uPV7tAe-UcCnFEo1yQwIiQFk6WKIReZqjjT8YxvTRMAU876-FvP8W2Je_JoZCp5EiarNeGTe1nVobovOh8_8Bpm1ERzVCzDlGlZuQ=s800)

Select start in production mode  then Click next

![](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfCHXcSSF91Edbo86u9Q4A6mvZ9S1FMC7Y05TpQXBxqTa_NS60v3nspwNgMbIzpgGzn6B176qGp-VU4pL6wIrb6ojYJtoSzPM7ojkJYlvaPM97gS1IWc22AJkjSNGi9EhiJvPUttwER5QHVvorF3jQpLA21msgVP=s800)

then you will be asked to select the location, select asia-southeast1 or 2 for the better latency time.

1.4. When you finish creating the cloud storage, you will see the screen. write your bucket name shown on the screen. you will use it later

![](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfCdi5cRPUbEj-Y3oA1fZrvemSkLr20UA9qjf3qWGtkPVdu4NmG-MmPYd5pYJRTtybaFQZqtfk78hoY7ClmotTsmktTsEGR6oxbpw9dt-RVXxx_2oy9QNlnoxPU9Hah0VPr2Dw9tJE9CEDpfHfeMZMR-hwGd6CZn=s800)

1.5. After note the bucket name, open the project setting

![A screenshot of a computer

Description automatically generated](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfDlD8qgrbQOyVP0UWY-kcfF_HaLpTMwQYuzDklCCbmHODI-20gaj8qTbcp2XHCbRZoOpcpcXWygqUKH_rvLkleEJtvIOz728ZvkNSSvID_0iq74lgYTIMemSnYVoP5cNJGAbFQOMoPk64MYrIvymBJboFkAzw=s800)

1.6. Open Service accounts pane, click at “Services accounts”

![A screenshot of a computer

Description automatically generated](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfBHoVhTvOKokMo_Zucxytj0H6TJCYG1pN9wqRRa4BFzB87gAeseacfClIZNF-bvq1L4WRhj5YY1NnYt5ZvQDc5Wg-QfhlsSo9b2cWJ2xi0hb6jQS5Vet1OgWBr0VYoTANTTrwEq4D7yH8OPwS5R2KLc6QjktA=s800)

1.7. Select the service account

![A screenshot of a phone

Description automatically generated](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfBO0iRm3YNrpd2ITKqZ8LcQknbUe3obESRKQXjKRsFaInfkinvOt7AwFW-zdNguxLwr_v7OZLX9nn8MD2k7DnXX2SWdBf0plVibOuC5S3V3crjxlqg4uEqWA9UxgLdC5ux38YiFZLc0_Qpy9Hmcb4F6Yeyttd-G=s800)

1.8. Select the email which show as App Engine default service account, open the manage key  button

![A screenshot of a computer

Description automatically generated](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfA1OWb4AktCr5lRhPP-HJ-6Cs3V5-Qr9wWRWUPTwa6QMTwgHU09EH42p-ZgVH4aw_AgIzHBz9hq12I0Fk9t57B3-HErrYZBgyJMzqTYYG3k-Aqh7xW0iG4rXxdxBE1behB3-lVX_YV17QNXW4XQ8DX3_f4-YGRg=s800)

1.9. In key menu, click create new key

![A screenshot of a computer

Description automatically generated](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfALJPA4A9VaruIfSsXAs5vGzlhzv1hfvra6NEDUIaFRmt1wWsx6XbWnhHgrefypk7T0F9pqDuOJcFXnBbGhKRDxgBIkcnSVeL2FfMAmI_mvpLFoqgaAYY73R92IPeFafz8XYdMoEgh42p-SmPho-a1wYbeKeL3Z=s800)

1.10. You will be asked to create a key. Copy the Json File to your resource folder, in your project ( you may change the file name in order for easier reference)

![](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfAqV5iSPy-sBF3eE8_fPyZVjIYtk_TsR8LGj00AZPs7pd13T4HgdSlKbSF_EatzTCIUnf6_sYB4apc3W4UXomd0Y_XrbsoxjO6l78KOslsSVN6B6VlK6eHOE85tHgGyUG97sV1XtI4lvtVGCLC9i3X1_5RCew=s800)

1.11. Search the maven repository for google cloud storage component. add the dependency to your pom.xml

1.12.
   ```
   In util package, and then create CloudStorageHelper class as given
   ```

```
@Component
public class CloudStorageHelper {
   private static Storage storage = null;
   static {
```

```
       InputStream serviceAccount =
               null;
       try {
           serviceAccount = new ClassPathResource("[Your key file name]").getInputStream();
           storage = StorageOptions.newBuilder()
```

.setCredentials(GoogleCredentials.*fromStream*(serviceAccount))

```
                   .setProjectId("[your project id]")
                   .build().getService();
       } catch (IOException e) {
           e.printStackTrace();
       }
```

```
   }
   // [END init]
```

**

```
      public String uploadFile(MultipartFile filePart, final String bucketName) throws IOException {
```

```
       SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HHmmssSSS");
       String dtString = sdf.format(new Date());
       final String fileName = dtString + "-" +filePart.getOriginalFilename();
InputStream is = filePart.getInputStream();
       ByteArrayOutputStream os = new ByteArrayOutputStream();
       byte[] readBuf = new byte[4096];
       while (is.available() > 0) {
           int bytesRead = is.read(readBuf);
           os.write(readBuf, 0, bytesRead);
       }
       // Convert ByteArrayOutputStream into byte[]
       BlobInfo blobInfo =
               storage.create(
                       BlobInfo
                               .newBuilder(bucketName, fileName)
                               // Modify access list to allow all users with link to read file
                               .setAcl(new ArrayList<>(Arrays.asList(Acl.of(Acl.User.ofAllUsers(), Acl.Role.READER))))
```

.setContentType(filePart.getContentType())

```
                               .build(),
                       os.toByteArray());
       // return the public download link
       return blobInfo.getMediaLink();
   }
```

```
      public String getImageUrl(MultipartFile file,                             final String bucket) throws IOException, ServletException {
```

```
       final String fileName = file.getOriginalFilename();
       // Check extension of file
       if (fileName != null && !fileName.isEmpty() && fileName.contains(".")) {
           final String extension = fileName.substring(fileName.lastIndexOf('.') + 1);
           String[] allowedExt = {"jpg", "jpeg", "png", "gif"};
           for (String s : allowedExt) {
               if (extension.equals(s)) {
                   return this.uploadFile(file, bucket);
               }
           }
           throw new ServletException("file must be an image");
       }
       return null;
   }
}
```

Note your project id can be found in the Project General Page

if you have any errors, please check that you import the correct class as given

![](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfAOyWcs86BbCu7_rA9RUL1QF_i_IMo1aKPAABLu66hJI1W3pQiq9JPHPZd-XNZuSBbuMDnKFLQflC0lm66OYU4iRjfI_hMlLYT5uKnUee6RDbEyKToBC_-SW273r78xRx8iRgx--TdIyZ0CYdLmbUtT0GT_LQ=s800)

1.13. Create the upload endpoint by creating the BucketContorller class in the controller package using the given code

```
@Controller
@RequiredArgsConstructor
public class BucketController {
```

```
   final CloudStorageHelper cloudStorageHelper;
   @PostMapping("/uploadFile")
```

```
   public ResponseEntity<?> uploadFile(@RequestPart(value = "file") MultipartFile file) throws IOException, ServletException {
```

```
       return ResponseEntity.ok(this.cloudStorageHelper.getImageUrl(file,"[your bucket name with appspot]"));
```

```
   }
}
```

1.14. Open the ApiDog, try to upload the file using the given command

![A screenshot of a computer

Description automatically generated](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfC3oyfaIh9hJYkKAB8ZHKlyQ0EPXW42I21baxW8JU1jicO5bML14_V1UKIZiSggg0YyijTlgwwHvXKd0H5-4nW-HRfBHHx5ruSWkeg1-YtO9plluFQnLBNyX9AE9nxvpHdpE5supNDcR1PJyWCDRjx5wJT3NA=s800)

_You should upload the image, after you have uploaded the file, you will get the url as the return value. Copy the return url, and paste it in the browser to get the mark._

Note you may find the error saying that the size of the file exceeds the limit. Please update the application.yml for setting a new upload limit as given

![](https://web.archive.org/web/20250925082143im_/https://lh7-rt.googleusercontent.com/docsd/ANYlcfCD12xVhfa4vWoR3oEekhJQQ0qnP9JGwNHtrz6vD-Jfz4B9ShazUtu7FcbTiMR7nnSGj2g_S3Tqm4tmAutTIx6n0sAiyLlVnIzd9RC2yRDQ-TPuU0CUnyWAKOii9umLWzrUm_W4UDJUYQEHipSC_T0EnMibmRK4=s800)

2. Provide the code for uploading the images

2.1. install the vue-media-upload component which you can find the details here  by running the following command in the root of the project

```
                npm i vue-media-upload --save
```

you may see the demo by googling the vue-upload-drop-images

2.2. Create the component to handle the vue-media-upload component so that we can add the component to our application easily. Create the ImageUpload.vue in the component folders

```
<script setup lang="ts">
import Uploader from 'vue-media-upload'
import { ref } from 'vue'
interface Props {
 modelValue?: string[]
}
const props = withDefaults(defineProps<Props>(), {
 modelValue: () => []
})
const convertStringToMedia = (str: string[]): any => {
 return str.map((element: string) => {
   return {
     name: element
   }
 })
}
const emit = defineEmits(['update:modelValue'])
const convertMediaToString = (media: any): string[] => {
 const output: string[] = []
 media.forEach((element: any) => {
   output.push(element.name)
 })
```

return output

```
}
const media = ref(convertStringToMedia(props.modelValue))
const uploadUrl = ref(import.meta.env.VITE_UPLOAD_URL)
const any) => {
```

emit(&#39;update:modelValue&#39;, convertMediaToString(files))

```
}
</script>
<template>
 <Uploader :server="uploadUrl" @change="onChanged" :media="media"></Uploader>
</template>
```

2.3. You may notice that the component requires the VITE_MEDIA_ROOT_URL as the location of the uploaded server. specify it in the dev.environment file

```
VITE_UPLOAD_URL=http://localhost:8080/uploadFile
```

2.4. If you install the plugin properly, you will see the warning on the import of the Uploader. This is because the component is not the proper typescript component (as the time I create this lab sheet, I could not find the proper component with the typescript support). However, we can force the IDE to know this type.

Create the file name index.d.ts in the root folder and add this content

```
declare module 'vue-media-upload';
        then open the env.d.ts and then add this code 
/// <reference types="vite/client" />
/// <reference types="vue-media-upload" />
        finally, open the tsconfig.app.json then update the code as given
```

&quot;extends&quot;: &quot;@vue/tsconfig/tsconfig.dom.json&quot;,

&quot;include&quot;: [&quot;env.d.ts&quot;, &quot;src/**/*&quot;, &quot;src/**/*.vue&quot;],

&quot;include&quot;: [&quot;env.d.ts&quot;, &quot;src/**/*&quot;, &quot;src/**/*.vue&quot;, &quot;index.d.ts&quot;],

&quot;exclude&quot;: [&quot;src/**/__tests__/*&quot;],

now the warning should be gone

2.5. Update the EventItem type to receive the images list from the upload component, add images to the type EventItem in the type.ts

```
 date: string
 time: string
```

organizer: EventOrganizer

```
 images: string[]
}
```

2.6. Update the EventFormView.vue to use the ImageUpload components

```
import OrganizerService from '@/services/OrganizerService'
import ImageUpload from '@/components/ImageUpload.vue';
const event = ref<EventItem>({
```

…

```
   location: '',
   date: '',
   time: '',
   organizer: { id: 0, name: '' }
   organizer: { id: 0, name: '' },
   images: []
})
```

…

```
           <h3>Who is your organizer?</h3>
           <BaseSelect v-model="event.organizer.id" label="Organizer" :options="organizers" />
           <h3>The image of the Event</h3>
           <ImageUpload v-model="event.images" />
           <button type="submit">Submit</button>
       </form>
```

Now try to upload the image. Note that you may see the developer console to see is there any problems or not.

update the CloudStorageHelper.java to make the uploadFile more flexible with the name

2.7. If we get back to the document of the vue-media-upload, the documents said that the return data should be in the specific format. we have to update our backend to conform to the third-party. Update the controller, and the cloud service as given.

Create the entity which support the image upload component

Create a new java file name StorageFileDto in the util package

```
package se331.lab.rest.util;
import lombok.Builder;
import lombok.Data;
@Builder
@Data
public class StorageFileDto {
   String name;
}
```

add the new methods in the CloudStorageHelper.java

```
   public StorageFileDto getStorageFileDto(MultipartFile file, final String bucket)                                                            throws IOException, ServletException {
```

```
       final String fileName = file.getOriginalFilename();
       // Check extension of file
       if (fileName != null && !fileName.isEmpty() && fileName.contains(".")) {
           final String extension = fileName.substring(fileName.lastIndexOf('.') + 1);
           String[] allowedExt = {"jpg", "jpeg", "png", "gif"};
           for (String s : allowedExt) {
               if (extension.equals(s)) {                        
                   String urlName = this.uploadFile(file, bucket);
                   return StorageFileDto.builder()
                           .name(urlName)                           
                          .build();
               }
           }
           throw new ServletException("file must be an image");
       }
       return null;
   }
```

then add a new method to the BucketCopntroller.java

```
   @PostMapping("/uploadImage")
```

```
   public ResponseEntity<?> uploadFileComponent(@RequestPart(value = "image") MultipartFile file) throws IOException, ServletException {
```

```
       return ResponseEntity.ok(this.cloudStorageHelper.getStorageFileDto(file," [your bucket name with appspot]"));
```

```
   }
```

now get back to the frontend, update the upload url to the new endpoint

```
VITE_UPLOAD_URL=http://localhost:8080/uploadImage
```

_restart all the server, now you should be able to add the file to the component. Check in your firebase storage bucket that the file is now in your bucket_.

2.8. Now update the Backend to save the data to our database.

update the Event.java to add the images

```
   @ManyToMany(mappedBy = "eventHistory")
   List<Participant> participants;
   @ElementCollection
   List<String> images;
}
```

then update the EventDTO.java to send the events object

```
   EventOrganizerDTO organizer;
   List<String> images;
}
```

then update the event/DetailView in the frontend to show the images after adding a new data

```
   <p>{{ event.time }} on {{ event.date }} @ {{ event.location }}</p>
   <p>{{ event.description }}</p>
   <div class="flex flex-row flex-wrap justify-center">
     <img v-for="image in event.images" :key="image" :src="image" alt="events image"
       class="border-solid border-gray-200 border-2 rounded p-1 m-1 w-40         hover:shadow-lg" />
   </div>
 </div>
```

_add a new event in the frontend  to show that the details, and images are shown properly in the event details, and show that the data is already in the database._

__

3. From the Organizer page you have done earlier.

3.1. create the create Organizer page,  which can add the image url to the organizer. note that only 1 image is allowed to be added in the Organizer object.
3.2. Implement the Organizer detail  to show the Organizer data and image.
